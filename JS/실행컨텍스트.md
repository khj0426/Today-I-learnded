## ECMAScript에서 소스코드는 4가지로 평가된다.

<br>
4가지 타입의 코드는 실행 컨텍스트를 생성하게 된다.<br>
<br>
1. global code : 전역에 존재하는 코드를 의미한다.
<br>
2. function code : 함수 내부에 존재하는 코드를 의미한다
<br>
3. eval code : eval함수에 인수로 전달되어 생성되는 코드를 의미한다.
<br>
4. module code : 모듈 내부에 존재하는 코드를 의미한다
<br></br>

### <b>전역 코드의 생성 시점</b>

<br>
전역 코드는 전역 스코포를 생성한다.
<br></br>
var키워드로 선언된 변수, 함수 선언문으로 정의된 함수를 전역 객체의 프로퍼티와 메서드로 바인딩하고, 전역객체와 연결한다.
<br></br>

### 전역 코드가 평가되면 -> 전역 실행 컨텍스트가 만들어진다

```
var value = 100;
console.log(window.value) //100

--전역 객체 window의 프로퍼티가 된 전역 변수 value --
```

### <b>함수 코드의 생성 시점</b>

<br>
함수 코드는 지역 스코프를 만들고 지역변수, 매개변수를 관리한다.
<br>또한 생성된 지역 스코프를 스코프체인과 연결해야 한다.
<br></br>
<b>함수 코드가 평가되면 함수 실행 컨텍스트가 만들어진다</b>
<br></br>

### <b>즉, 소스코드를 평가해서 실행 컨텍스트를 만든다!</b>

<hr></hr>
<br>

## 🤨소스코드는 언제 평가되고 실행되는거죠?

<br>

자바스크립트는 `소스코드의 평가`, `소스코드의 실행` 으로 소스코드를 처리한다.

<h3> 1.소스코드의 평가 단계</h3>

```
실행 컨텍스트를 만들고, 선언문을 실행해, 식별자를 키로 실행 컨텍스트가 관리하는 스코프(렉시컬 환경)에 등록한다
```

<p>소스코드의 평가 단계과 끝나면 소스코드의 실행이 이어진다</p>
<br>

<h3> 2. 소스코드의 실행단계(런타임)

```
소스코드 실행에 필요한 정보들, 변수나 함수를 참조할 떄,
실행 컨텍스트가 관리하는 스코프에서 이를 검색해서 얻는다.
변수 값의 변동 등 소스코드의 실행 결과는 다시 실행 컨텍스트가 관리하는 스코프에 등록된다.
```

![](https://images.velog.io/images/injoon2019/post/c0db3201-35a8-4170-a588-5b46d896c86e/image.png)

```
var x;
x = 1;
```

<p>1.소스코드의 평가단계에서, 실행 컨텍스트를 만들고 선언문을 먼저 실행해서, 식별자를 렉시컬 환경에 등록한다</p>

```
(렉시컬 환경이라고 가정할떄)
{
    x:undefined
}

```

<p>2.그 후, 변수 할당문 x = 1;이 실행된다. <b>실행컨텍스트가 관리하는 스코프에 x가 있는지 확인한다</b></p>
<p>만약 존재하면, 소스코드 평가단계에서 선언문이 실행되어 등록된 변수다. 값을 할당하고 실행컨텍스트에 등록한다</p>

```
{
    x:1
}

```

<hr></hr>
<br>

## 🌕실행 컨텍스트의 흐름

```
//전역 변수
const x = 1;
const y = 2;

//함수 선언문
function foo(a){
    const x = 3;
    const y = 4;

    //메서드 실행
    console.log(a+x+y);// 17
}

//함수 호출
foo(10);

//메서드 호출
console.log(x+y); // 3
```

### 🚩전역 코드의 평가

선언문만 먼저 실행된다. 전역 코드의 변수 선언문, 함수 선언문이 먼저 실행되고, 생
성된 전역 변수와 함수가, 전역 스코프에 등록된다<br>

이떄, var키워드로 선언한 전역 변수, 함수 선언문의 함수는 전역 객체의 메서드와 프
로퍼티가 된다 <br></br>

### 🚩전역 코드의 실행

런타임에 전역 코드가 순서대로 읽히기 시작한다. 이떄, 전역 변수에 값이 할당되고함
수가 호출된다.

<p><b>함수 호출 시, 코드의 제어권이 함수로 넘어간다</b></p>
<br></br>

### 🚩힘수 코드의 평가

함수 호출 시, 함수 내부 문들을 실행 하기 전, 함수 코드의 평가 과정을 거친다.

<p>매개변수, 지역 변수 선언문이 실행되고, 생성된 매개변수, 지역변수가 지역 스코프에 등록된다</p>
<p>arguments 객체가 생성되고, this 바인딩도 이때 결정된다</p>
<br></br>

### 🚩함수 코드의 실행

런타임이 시작되고 호출된 함수 내부 코드가 실행된다. 매개변수와 지역 변수에 값이
할당되고 console.log()도 실행된다. <br>

console.log()을 실행 전에, `스코프 체인`에서 console을 검색한다. console은 전역
객체의 프로퍼티로 존재한다.

<p>전역 스코프를 통해 console은 검색 가능하다 (함수코드의 지역스코프 - 전역 스코프)</p>
<p>다음으로 console객체의 <b>프로토타입 체인</b>에서 log 메서드를 찾는다<p>
그 후, console.log메서드에 인수로 전달된 표현식이 평가된다. (마찬가지로 인수도 스코프 체인으로 찾는다)
<p>더 실행할 문이 없을 떄 전역 코드로 다시 돌아간다</p>

<hr></hr>
<br>

## 🌕그래서 실행 컨텍스트가 하는 것?

1. `선언에 의해 생성된 식별자`를 스코프에 따라 구분해서, 지속적으로 관리한다.
   <br>

2. `스코프 체인`으로 상위 스코프로 가면서 `식별자를 검색 가능하게`한다. <br>

3. `코드의 제어권`을 관리한다. `함수 호출에 따른 실행 순서`가 변경 될 수 있어야
   한다. <br>

```
const x = 1;
function foo(){
    const y = 2;
    function bar(){
        const z = 3;
        console.log(x+y+z);
    }
    bar();
}
foo(); //6

```

<hr></hr>
<br>

<h2>🌕 1.빈 실행 스택</h2>

<br>

<h2>🌕 2.전역 실행 컨텍스트 push</h2>

```
전역 코드를 평가해 전역 실행 컨텍스트를 만들고 컨텍스트 스택에 넣는다.
전역 변수 x, 함수 foo는 전역 실행 컨텍스트에 등록된다.
전역 코드가 실행되고 x에 값이 할당되고 foo가 호출된다
```

<br>

<h2>🌕3.foo함수의 평가,실행 [stack.push(foo)] </h2>

```
전역 함수 foo() 호출 시, 코드의 제어권이 foo 함수 안으로 넘어간다.

foo 함수 내부의 코드를 평가해 foo 함수 컨텍스트를 만들고, 컨텍스트에 넣는다.

foo의 지역변수 y, 중첩 함수 bar가 foo 함수 컨텍스트에 등록된다.
그 후, foo 함수코드가 실행되어 y에 변수의 값이 들어가고 bar()가 호출된다.
```

<br>

<h2>🌕4.bar함수의 평가, 실행 [stack.push(bar)] </h2>

```
중첩 함수 bar() 호출 시, 코드의 제어권이 bar함수로 넘어간다.
마찬가지로 bar 내부의 코드를 평가해 bar 함수 컨텍스트를 만들고,
컨텍스트 스택에 push한다.

bar 함수 지역변수 z가 bar 함수 실행 컨텍스트에 등록된다.
그 후, bar함수가 실행되어 z에 값이 할당되고, console.log호출 후 종료된다.
```

<br>

<h2>🌕5.foo함수로 복귀 [stack.pop(bar)] </h2>

```
bar함수의 실행 할 코드가 존재하지 않는다면, foo함수로 코드의 제어권이 넘어간다.
```

<br>

<h2>🌕6.전역 코드로 복귀 [stack.pop(foo)] </h2>

```
foo 함수의 실행 할 코드가 존재하지 않아서, 전역 실행 컨텍스트로 코드의 제어권이 넘어간다.
```

<hr>
<br>

## 💪렉시컬 환경

렉시컬 환경은 식별자, 식별자에 연결된 값, 상위 스코프에 대한 참조를 기록하는
`자료구조`이다.

<p>실행 컨텍스트가 코드의 순서를 관리하면, 렉시컬 환경은 스코프, 식별자를 관리한다</p>

![](https://user-images.githubusercontent.com/80154058/142872952-6ffa7a76-41e3-4138-9ed1-2a610489f17f.png)

### <h3>💪 LexcialEnvironment, VariableEnvironment</h3>

실행 컨텍스트는 2가지 컴포넌트 (LexicalEnvironment,VariableEnvironment)로 구성된
다.

```
// Execution context in ES5ExecutionContext = {
  ThisBinding: <this value>,
  VariableEnvironment: { ... },
  LexicalEnvironment: { ... }
}
```

## 💪Lexical Environment

간단하게 Lexical Environment는 두 가지 요소를 갖는다.

<p><b>환경레코드</b>와 <b>외부 렉시컬 환경에 대한 참조를 갖는다</b></p>

```
var x = 10;
function foo(){
    var y = 20;
    console.log(x+y); //30
}
//**environmentRecord(환경레코드)
// reference to the outer environment(부모)**
(다른 렉시컬 환경에 대한 참조)

globalEnvironment = {
    environmentRecord :{
        x:10
    },
    outer:null //전역
};

//foo function Environment
fooEnvironment = {
    environmentRecord:{
        y:20
    },
    outer:globalEnvironment
}
```

<h3>환경 레코드</h3>

스코프에 포함된 식별자를 등록하고, 식별자에 바인딩 되어있는 값을 관리하는
`저장소`이다.

<br>

<h3>외부 렉시컬 환경에 대한 참조</h3>

상위 스코프를 가리킨다. (상위 스코프의 렉시컬 환경)

<br>

<hr>
<br>

## 👍실행 컨텍스트 생성, 식별자 검색 과정

```
var x = 1;
const y = 2;

function foo(a){
    var x = 3;
    const y = 4;
    function bar(b){
        const z = 5;
        console.log(a+b+x+y+z);
    }
    bar(10);
}

foo(20);
```

<h2>👍 전역 객체 생성</h2>

<br>
전역 코드 평가 이전에 생성된다. 전역 객체도 Object.prototype을 상속받는다.

<br>

![](/%EC%A0%84%EC%97%AD%20%EA%B0%9D%EC%B2%B4.png)

```
window->WindowProperties->EventTarget->Object
```

소스코드가 로드되면, 전역 코드가 평가된다. 다음과 같은 순서로 평가된다.

<hr>
<br>

<h3> 1.전역 실행 컨텍스트 생성</h3>
<br>
<h3> 2. 전역 렉시컬 환경 생성</h3>
<br>
    <h3>2.1 전역 환경 레코드 생성</h3>
    <br>
    <h3>2.2 객체 환경 레코드 생성</h3>
    <br>
    <h3>2.3 선언적 환경 레코드 생성</h3>
    <br>
    <h3>2.4 this 바인딩</h3>
    <br>
    <h3>2.5 외부 렉시컬 환경에 대한 참조 </h3>
